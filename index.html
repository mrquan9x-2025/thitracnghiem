<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOÃN THáº¦Y QUÃ‚N</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* BRANDING */
        .brand-title { text-align: center; color: #007bff; text-transform: uppercase; margin-bottom: 5px; font-size: 2em; letter-spacing: 1px; }
        .brand-subtitle { text-align: center; color: #666; font-style: italic; font-size: 1.1em; margin-top: 0; margin-bottom: 30px; }

        h2 { text-align: center; color: #333; margin-top: 30px;}
        .section-header { background: #e9ecef; padding: 10px; margin: 20px 0 10px; font-weight: bold; border-radius: 5px; color: #495057; text-transform: uppercase; font-size: 0.9em; }
        
        /* UI Elements */
        .btn { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 15px; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn-outline { background: transparent; border: 1px solid #007bff; color: #007bff; margin-top: 15px; }
        
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        
        /* Grid Layout Admin */
        .config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        .config-group { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .config-label { font-size: 0.9em; font-weight: bold; color: #333; margin-bottom: 5px; display: block; }

        /* Exam Layout */
        .question-box { background: #fff; padding: 20px; margin-bottom: 15px; border: 1px solid #e1e4e8; border-radius: 8px; }
        .q-title { font-weight: bold; margin-bottom: 10px; display: block; color: #2c3e50; }
        
        /* --- Sá»¬A UI MOBILE --- */
        .options-grid { 
            display: flex; 
            gap: 5px; /* Giáº£m khoáº£ng cÃ¡ch Ä‘á»ƒ khÃ´ng bá»‹ rá»›t dÃ²ng */
            justify-content: space-between; /* CÄƒn Ä‘á»u 2 bÃªn */
            margin-top: 10px; 
            flex-wrap: nowrap; /* KhÃ´ng cho phÃ©p xuá»‘ng dÃ²ng */
        }
        .option-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            flex: 1; /* Chia Ä‘á»u chiá»u rá»™ng */
        }
        .option-label { font-weight: bold; margin-bottom: 8px; color: #555; }
        input[type="radio"] { transform: scale(1.3); cursor: pointer; margin: 0; }

        .matrix-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .tf-group { display: flex; gap: 20px; }
        .tf-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        /* -------------------- */

        .warning-box { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 20px 0; border: 1px solid #ffeeba; text-align: center; font-weight: bold; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none; }

	/* Spinner nhá» náº±m trong nÃºt báº¥m */
	.btn-loader {
    		border: 3px solid rgba(255,255,255,0.3);
    		border-top: 3px solid white;
    		border-radius: 50%;
    		width: 20px;
    		height: 20px;
    		animation: spin 1s linear infinite;
    		display: inline-block;
    		vertical-align: middle;
    		margin-right: 10px;
	}
	/* Tráº¡ng thÃ¡i nÃºt khi Ä‘ang xá»­ lÃ½ */
		.btn:disabled {
    		background-color: #95a5a6; /* MÃ u xÃ¡m */
    		cursor: not-allowed;
    		opacity: 0.8;
	}

	/* ThÃªm vÃ o trong tháº» <style> */
	.footer-credit {
    		margin-top: 40px;
    		font-size: 12px;
    		color: #999;
    		text-align: center;
    		border-top: 1px solid #eee;
    		padding-top: 15px;
    		font-family: monospace; /* Font chá»¯ kiá»ƒu code cho ngáº§u */
	}

    </style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    /* ThÃªm CSS cho dÃ²ng lá»i nháº¯n */
    .feedback-msg {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        font-style: italic;
        text-align: center;
        font-size: 1.1em;
        animation: fadeIn 1s ease-in;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* MÃ u sáº¯c theo má»©c Ä‘á»™ */
    .fb-low { background: #fff5f5; color: #c53030; border-left: 5px solid #c53030; } /* Äá» */
    .fb-mid { background: #fffaf0; color: #d69e2e; border-left: 5px solid #d69e2e; } /* VÃ ng cam */
    .fb-high { background: #f0fff4; color: #2f855a; border-left: 5px solid #2f855a; } /* Xanh lÃ¡ */
</style>
</head>
<body>

<div class="container">
    <div id="loader" class="loader"></div>
    
<div id="main-screen">
        <h1 class="brand-title">TOÃN THáº¦Y QUÃ‚N</h1>
        
        <p class="brand-subtitle" id="slogan-display">ChÄƒm há»c ToÃ¡n - SÃ¡ng tÆ°Æ¡ng lai</p>
        
        <input type="text" id="hs-name" placeholder="Há» vÃ  tÃªn há»c sinh">
        <input type="text" id="exam-code" placeholder="Nháº­p MÃ£ Äá» Thi (ChÃº Ã½ VIáº¾T HOA)">
        <button class="btn" onclick="vaoThi()">Báº®T Äáº¦U LÃ€M BÃ€I</button>
        <button class="btn btn-outline" onclick="showLoginAdmin()" style="font-size: 0.85em; padding: 8px;">DÃ nh cho GiÃ¡o viÃªn</button>

        <div class="footer-credit">Design by QuÃ¢nPT</div>
    </div>

    <div id="login-admin" class="hidden">
        <h2>GiÃ¡o viÃªn ÄÄƒng nháº­p</h2>
        <input type="password" id="admin-pass" placeholder="Máº­t kháº©u">
        <button class="btn" onclick="loginAdmin()">VÃ o quáº£n trá»‹</button>
        <button class="btn btn-outline" onclick="location.reload()">Quay láº¡i</button>
    </div>

    <div id="admin-panel" class="hidden">
        <a href="https://mrquan9x-2025.github.io/quanlythiv3/" style="text-decoration: none;">
            <button class="btn btn-outline" style="margin-bottom: 20px; border-color: #28a745; color: #28a745; font-weight: bold;">
                ğŸ“Š THá»NG KÃŠ Káº¾T QUáº¢ THI
            </button>
        </a>
        <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 20px;">

        <h2>Táº¡o Äá» Thi Má»›i</h2>
        <input type="text" id="new-exam-code" placeholder="MÃ£ Ä‘á» (VD: TEST01)">
        <input type="text" id="new-exam-name" placeholder="TÃªn Ä‘á» thi">

        <div class="config-group">
            <div class="section-header" style="margin-top:0">Cáº¥u hÃ¬nh Pháº§n 1 (Tráº¯c nghiá»‡m)</div>
            <div class="config-row">
                <div><label class="config-label">Sá»‘ cÃ¢u:</label><input type="number" id="cfg-p1-num" value="12"></div>
                <div><label class="config-label">Äiá»ƒm/cÃ¢u:</label><input type="number" id="cfg-p1-score" value="0.25" step="0.01"></div>
            </div>
        </div>

        <div class="config-group">
            <div class="section-header">Cáº¥u hÃ¬nh Pháº§n 2 (ÄÃºng/Sai)</div>
            <div class="config-row">
                <div><label class="config-label">Sá»‘ cÃ¢u:</label><input type="number" id="cfg-p2-num" value="4"></div>
                <div><label class="config-label">TÃ­nh Ä‘iá»ƒm:</label>
                    <select id="cfg-p2-mode">
                        <option value="bac_thang">Báº­c thang (0.1 - 0.25 - 0.5 - 1)</option>
                        <option value="chia_deu">Chia Ä‘á»u (0.25Ä‘ / Ã½)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="config-group">
            <div class="section-header">Cáº¥u hÃ¬nh Pháº§n 3 (Tráº£ lá»i ngáº¯n)</div>
            <div class="config-row">
                <div><label class="config-label">Sá»‘ cÃ¢u:</label><input type="number" id="cfg-p3-num" value="6"></div>
                <div><label class="config-label">Äiá»ƒm/cÃ¢u:</label><input type="number" id="cfg-p3-score" value="0.5" step="0.01"></div>
            </div>
        </div>

        <div style="background: #e2e6ea; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 0.9em;">
            <strong>HÆ°á»›ng dáº«n:</strong> Nháº­p liÃªn tiáº¿p Ä‘Ã¡p Ã¡n tá»« trÃªn xuá»‘ng dÆ°á»›i (Háº¿t P1 -> P2 -> P3).
        </div>
        <textarea id="exam-data-input" rows="8" placeholder="DÃ¡n Ä‘Ã¡p Ã¡n vÃ o Ä‘Ã¢y..."></textarea>
        
        <button class="btn" onclick="luuDeThi()">LÆ°u Äá» Thi</button>
        <button class="btn btn-outline" onclick="location.reload()">ThoÃ¡t</button>
    </div>

    <div id="exam-interface" class="hidden">
        <h2 id="exam-title-display"></h2>
        <div id="questions-container"></div>
        <button class="btn" onclick="nopBai()">Ná»˜P BÃ€I</button>
    </div>

    <div id="result-interface" class="hidden">
        <h2>Káº¾T QUáº¢: <span id="score-display" style="color:red; font-size: 2em"></span></h2>
        <div id="result-details"></div>
        <button class="btn" onclick="location.reload()">LÃ m Ä‘á» khÃ¡c</button>
    </div>
</div>

<script>
// --- Cáº¤U HÃŒNH SLOGAN NGáºªU NHIÃŠN ---
    // Tháº§y thay ná»™i dung 5 cÃ¢u nÃ³i á»Ÿ Ä‘Ã¢y nhÃ©:
    const listSlogans = [
        "ChÄƒm há»c ToÃ¡n - SÃ¡ng tÆ°Æ¡ng lai",
        "CÃ¡ch duy nháº¥t Ä‘á»ƒ Há»c ToÃ¡n lÃ  LÃ m ToÃ¡n",
        "Má»—i ngÃ y há»c táº­p lÃ  má»™t cÆ¡ há»™i Ä‘á»ƒ trá»Ÿ thÃ nh phiÃªn báº£n tá»‘t hÆ¡n cá»§a chÃ­nh mÃ¬nh",
        "HÃ£y há»c khi ngÆ°á»i khÃ¡c ngá»§, lao Ä‘á»™ng khi ngÆ°á»i khÃ¡c lÆ°á»i nhÃ¡c, chuáº©n bá»‹ khi ngÆ°á»i khÃ¡c chÆ¡i bá»i vÃ  cÃ³ Ä‘Æ°á»£c giáº¥c mÆ¡ cá»§a mÃ¬nh khi má»i ngÆ°á»i chá»‰ ao Æ°á»›c.",
        "Há»c táº­p giá»‘ng nhÆ° chÃ¨o thuyá»n ngÆ°á»£c dÃ²ng, khÃ´ng tiáº¿n áº¯t sáº½ lÃ¹i"
    ];

    // Tá»± Ä‘á»™ng chá»n 1 cÃ¢u vÃ  hiá»ƒn thá»‹ khi trang web táº£i xong
    document.addEventListener("DOMContentLoaded", function() {
        const randomSlogan = listSlogans[Math.floor(Math.random() * listSlogans.length)];
        const sloganElement = document.getElementById('slogan-display');
        if(sloganElement) sloganElement.innerText = randomSlogan;
    });
    // -----------------------------------

    // --- HÃ€M CHUáº¨N HÃ“A Há»Œ TÃŠN TIáº¾NG VIá»†T ---
    function chuanHoaTen(str) {
        // 1. XÃ³a khoáº£ng tráº¯ng thá»«a á»Ÿ Ä‘áº§u, cuá»‘i vÃ  giá»¯a cÃ¡c tá»«
        str = str.trim().replace(/\s+/g, ' ');
        // 2. Chuyá»ƒn táº¥t cáº£ vá» chá»¯ thÆ°á»ng, sau Ä‘Ã³ viáº¿t hoa chá»¯ cÃ¡i Ä‘áº§u má»—i tá»«
        return str.toLowerCase().replace(/(^|\s)\S/g, function(l) { 
            return l.toUpperCase(); 
        });
    }

    // --- THAY LINK API Cá»¦A THáº¦Y VÃ€O ÄÃ‚Y ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwrijo6SO5gMM5u7Adr24IaUA7_UoDmb5GKHzNWABLZ-tIK1Fr6FyOpEmX_8Xa4h2pc/exec"; 
    // ---------------------------------------

    let currentExamConfig = {};
    let currentExamQuestions = [];
    let studentName = "";
    let examCode = "";

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
    function hideAll() {
        document.getElementById('main-screen').style.display = 'none';
        document.getElementById('login-admin').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('exam-interface').style.display = 'none';
        document.getElementById('result-interface').style.display = 'none';
    }

    async function vaoThi() {
         // --- Cáº¬P NHáº¬T: Xá»¬ LÃ Há»Œ TÃŠN THÃ”NG MINH ---
        const nameInput = document.getElementById('hs-name');
        let rawName = nameInput.value;
        
        // BÆ°á»›c 1: Chuáº©n hÃ³a (Tá»± Ä‘á»™ng viáº¿t hoa chá»¯ cÃ¡i Ä‘áº§u)
        let cleanName = chuanHoaTen(rawName);
        
        // BÆ°á»›c 2: Kiá»ƒm tra Ä‘á»™ dÃ i (Pháº£i cÃ³ Ã­t nháº¥t 2 tá»«)
        if (!cleanName || cleanName.split(' ').length < 2) {
            alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ Há» vÃ  TÃªn (VÃ­ dá»¥: Nguyá»…n VÄƒn An)");
            nameInput.focus();
            return;
        }

        // BÆ°á»›c 3: GÃ¡n láº¡i tÃªn Ä‘Ã£ chuáº©n hÃ³a vÃ o Ã´ input Ä‘á»ƒ há»c sinh nhÃ¬n tháº¥y
        nameInput.value = cleanName;
        studentName = cleanName; // LÆ°u vÃ o biáº¿n toÃ n cá»¥c
        // ------------------------------------------

        const code = document.getElementById('exam-code').value.trim();
        examCode = code; // LÆ°u mÃ£ Ä‘á»

        if (!studentName || !examCode) {
            alert("Vui lÃ²ng nháº­p Ä‘á»§ Há» TÃªn vÃ  MÃ£ Ä‘á»!");
            return;
        }


        showLoader(true);
        try {
            const res = await fetch(`${API_URL}?action=get_exam&maDe=${examCode}&t=${Date.now()}`).then(r => r.json());
            if(res.status === 'error') { alert(res.msg); showLoader(false); return; }
            
            hideAll();
            document.getElementById('exam-interface').style.display = 'block';
            document.getElementById('exam-title-display').innerText = res.data.tenDe;
            
            currentExamConfig = res.data.config;
            currentExamQuestions = res.data.cauHoi;
            renderQuestions(res.data.cauHoi, res.data.config);
        } catch(e) { console.error(e); alert("Lá»—i káº¿t ná»‘i!"); }
        showLoader(false);
    }

    function renderQuestions(list, config) {
        let html = '';
        let p1_end = parseInt(config.p1_num);
        let p2_end = p1_end + parseInt(config.p2_num);

        list.forEach((c, i) => {
            if (i === 0 && config.p1_num > 0) html += `<div class="section-header">PHáº¦N 1: TRáº®C NGHIá»†M (${config.p1_score}Ä‘/cÃ¢u)</div>`;
            if (i === p1_end && config.p2_num > 0) html += `<div class="section-header">PHáº¦N 2: ÄÃšNG/SAI (${config.p2_mode === 'chia_deu' ? 'Chia Ä‘á»u' : 'Báº­c thang'})</div>`;
            if (i === p2_end && config.p3_num > 0) {
                html += `<div class="section-header">PHáº¦N 3: TRáº¢ Lá»œI NGáº®N (${config.p3_score}Ä‘/cÃ¢u)</div>`;
                html += `<div class="warning-box">âš ï¸ LÆ°u Ã½: DÃ¹ng dáº¥u cháº¥m Ä‘á»ƒ nháº­p sá»‘ tháº­p phÃ¢n (VÃ­ dá»¥: 2.5)</div>`;
            }

            html += `<div class="question-box"><span class="q-title">CÃ¢u ${c.id}:</span>`;

            if(c.dang === 1) { 
                html += `<div class="options-grid">`;
                ['A','B','C','D'].forEach(opt => {
                    html += `<label class="option-item"><span class="option-label">${opt}</span><input type="radio" name="c${i}" value="${opt}"></label>`;
                });
                html += `</div>`;
            } 
            else if(c.dang === 2) { 
                html += `<div>`;
                ['a','b','c','d'].forEach((y, yi) => {
                    html += `<div class="matrix-row"><span class="matrix-label">Ã ${y}:</span> 
                        <div class="tf-group">
                            <label class="tf-item"><span class="tf-text">Ä</span><input type="radio" name="c${i}_${yi}" value="true"></label> 
                            <label class="tf-item"><span class="tf-text">S</span><input type="radio" name="c${i}_${yi}" value="false"></label>
                        </div></div>`;
                });
                html += `</div>`;
            } 
            else { 
                html += `<input type="text" id="c${i}" autocomplete="off" placeholder="Nháº­p káº¿t quáº£...">`;
            }
            html += `</div>`;
        });
        document.getElementById('questions-container').innerHTML = html;
    }

    async function nopBai() {
        if(!confirm("Báº¡n muá»‘n ná»™p bÃ i? Chá» 3 giÃ¢y Ä‘á»ƒ xem káº¿t quáº£!")) return;
        // 1. Láº¤Y NÃšT VÃ€ KHÃ“A NÃšT Láº I NGAY Láº¬P Tá»¨C
        const btnSubmit = document.querySelector('#exam-interface .btn'); 
        const originalText = btnSubmit.innerHTML; // LÆ°u láº¡i chá»¯ "Ná»˜P BÃ€I" cÅ©
        
        // Äá»•i giao diá»‡n nÃºt -> Äang loading
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<div class="btn-loader"></div> Äang cháº¥m Ä‘iá»ƒm...';

	// 2. Thu tháº­p dá»¯ liá»‡u bÃ i lÃ m (Giá»¯ nguyÃªn logic cÅ©)
        let baiLam = [];
        currentExamQuestions.forEach((c, i) => {
            if(c.dang === 1) {
                const el = document.querySelector(`input[name="c${i}"]:checked`);
                baiLam.push(el ? el.value : "");
            } else if(c.dang === 2) {
                let ans = [];
                for(let j=0; j<4; j++) {
                    const el = document.querySelector(`input[name="c${i}_${j}"]:checked`);
                    ans.push(el ? (el.value === 'true') : null);
                }
                baiLam.push(ans);
            } else {
                let val = document.getElementById(`c${i}`).value.replace(',', '.');
                baiLam.push(val);
            }
        });
        // 3. Gá»­i dá»¯ liá»‡u Ä‘i
        showLoader(true);
        const formData = new FormData();
        formData.append('action', 'submit_exam');
        formData.append('maDe', examCode);
        formData.append('tenHS', studentName);
        formData.append('baiLam', JSON.stringify(baiLam));

        try {
            const res = await fetch(API_URL, { method: 'POST', body: formData }).then(r => r.json());
            showLoader(false);
            // Náº¿u lá»—i thÃ¬ má»Ÿ láº¡i nÃºt Ä‘á»ƒ ná»™p láº¡i
            if(res.status === 'error') { 
                alert(res.msg); 
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = originalText;
                return; 
            }

// ... (Pháº§n trÃªn giá»¯ nguyÃªn) ...
            
            hideAll();
            document.getElementById('result-interface').style.display = 'block';
            document.getElementById('score-display').innerText = res.diem.toFixed(2);
            
            // --- PHáº¦N Má»šI: HIá»‚N THá»Š Lá»œI NHáº®N Äá»˜NG VIÃŠN ---
            const diem = res.diem;
            const ten = studentName.split(' ').pop(); // Láº¥y tÃªn (vÃ­ dá»¥ "Nguyá»…n VÄƒn A" -> "A")
            let msg = "";
            let msgClass = "";

           // NgÃ¢n hÃ ng lá»i nháº¯n
            const msgList = {
                lv1: ["Váº¡n sá»± khá»Ÿi Ä‘áº§u nan ğŸŒ±, Ä‘á»«ng náº£n chÃ­ {ten} nhÃ©! ğŸ’ª", "Tháº¥t báº¡i lÃ  máº¹ thÃ nh cÃ´ng ğŸ£, cá»‘ lÃªn {ten} Æ¡i! ğŸš€", "Cáº§n Ã´n ká»¹ láº¡i lÃ½ thuyáº¿t nha {ten} ğŸ“š, em sáº½ tiáº¿n bá»™ nhanh thÃ´i! ğŸ’ª", "Äá»«ng buá»“n nhÃ© {ten} ğŸ¤—, láº§n sau cháº¯c cháº¯n sáº½ tá»‘t hÆ¡n nhiá»u! ğŸŒˆ", "Cá»‘ gáº¯ng hÆ¡n chÃºt ná»¯a nhÃ© {ten} ğŸ’ª, má»—i láº§n thá»­ lÃ  má»™t bÆ°á»›c tiáº¿n rá»“i! ğŸƒ"],
                lv2: ["ÄÃ£ cÃ³ cá»‘ gáº¯ng ğŸ‘, nhÆ°ng cáº§n táº­p trung hÆ¡n nha {ten} âš¡", "KhÃ¡ hÆ¡n rá»“i Ä‘Ã³ {ten} ğŸŒŸ, nhÆ°ng chÆ°a Ä‘áº¡t phong Ä‘á»™ tá»‘t nháº¥t Ä‘Ã¢u ğŸ˜‰", "Cáº©n tháº­n hÆ¡n xÃ­u ná»¯a lÃ  Ä‘iá»ƒm cao ngay thÃ´i {ten} Æ¡i ğŸ¯", "Ã”n luyá»‡n bÃ i táº­p cÆ¡ báº£n nhiá»u hÆ¡n nhÃ© {ten} ğŸ“š", "Tiáº¿p tá»¥c ná»— lá»±c nhÃ© {ten} ğŸ’ª, sáº¯p cháº¡m má»‘c KhÃ¡ rá»“i ğŸŒ»"],
                lv3: ["Káº¿t quáº£ khÃ¡ tá»‘t ğŸ‘, phÃ¡t huy nhÃ© {ten}! ğŸ˜‰", "Ná»n táº£ng khÃ¡ á»•n rá»“i ğŸ‘, {ten} cá»‘ gáº¯ng luyá»‡n Ä‘á» nhiá»u hÆ¡n nha ğŸ”¥", "Sáº¯p giá»i rá»“i ğŸŒŸ, cá»‘ thÃªm chÃºt ná»¯a nÃ o {ten} ğŸš´", "Äiá»ƒm nÃ y cho tháº¥y {ten} Ä‘Ã£ náº¯m Ä‘Æ°á»£c kiáº¿n thá»©c cÆ¡ báº£n ğŸ‘. Tiáº¿p tá»¥c cá»‘ gáº¯ng nhÃ©! ğŸŒˆ", "KhÃ¡ á»•n Ä‘Ã³ {ten} ğŸ˜, láº§n sau má»¥c tiÃªu 8+ nhÃ©! ğŸ’ª"],
                lv4: ["Káº¿t quáº£ á»•n Ä‘Ã³ ğŸ‘, chÃºc má»«ng {ten} vÃ¬ sá»± tiáº¿n bá»™ nÃ y! ğŸ‰", "Ráº¥t Ä‘Ã¡ng khen ğŸ‘, {ten} giá»¯ vá»¯ng phong Ä‘á»™ nhÃ© ğŸ˜‰", "Äiá»ƒm sá»‘ Ä‘áº¹p ğŸŒŸ, chÃºc má»«ng {ten}! Tiáº¿p tá»¥c phÃ¡t huy nhÃ©! ğŸš€", "{ten} Æ¡i, chá»‰ cáº§n cáº©n tháº­n chÃºt xÃ­u ná»¯a lÃ  cháº¡m má»‘c cao hÆ¡n rá»“i! ğŸ”¥", "{ten} Ä‘ang há»c ráº¥t hiá»‡u quáº£ ğŸ”¥, cá»‘ gáº¯ng giá»¯ nhá»‹p nÃ y nha! ğŸ˜"],
                lv5: ["Má»™t bÃ i lÃ m cháº¥t lÆ°á»£ng cao ğŸŒŸ, tiáº¿p tá»¥c giá»¯ phong Ä‘á»™ nhÃ© {ten}! ğŸš€", "Kiáº¿n thá»©c cá»§a {ten} khÃ¡ vá»¯ng rá»“i ğŸŒˆ, chÃºc má»«ng em! ğŸ‘", "Chá»‰ thiáº¿u chÃºt xÃ­u ná»¯a lÃ  Ä‘iá»ƒm tuyá»‡t Ä‘á»‘i rá»“i {ten} Æ¡i ğŸ¤©", "Tuyá»‡t vá»i Ã´ng máº·t trá»i! ğŸŒ ChÃºc má»«ng {ten}! ğŸ‘", "Phong Ä‘á»™ Ä‘á»‰nh chÃ³p ğŸ‘, tiáº¿p tá»¥c tháº¿ nÃ y nhÃ© {ten}! ğŸŒŸ"],
                lv6: ["Äá»ˆNH CHÃ“P! ğŸ’¯ {ten} lÃ  niá»m tá»± hÃ o cá»§a cáº£ lá»›p! ğŸ˜", "QuÃ¡ xá»‹n rá»“i {ten} ğŸ‰, Ä‘Ãºng chuáº©n há»c sinh gÆ°Æ¡ng máº«u! ğŸ‘", "Äá»‰nh cá»§a chÃ³p! ğŸ‘ ChÃºc má»«ng {ten} nhÃ© ğŸ‰", "Káº¿t quáº£ ráº¥t áº¥n tÆ°á»£ng ğŸ¤©, 10 Ä‘iá»ƒm trÃ²n trá»‹a cho sá»± ná»— lá»±c cá»§a {ten} ğŸ‰", "Tuyá»‡t vá»i Ã´ng máº·t trá»i! ğŸŒ ChÃºc má»«ng {ten}! ğŸ‰"]
            };

            // Chá»n nhÃ³m lá»i nháº¯n
            let selectedArr = [];
            if (diem < 4) { selectedArr = msgList.lv1; msgClass = "fb-low"; }
            else if (diem < 6) { selectedArr = msgList.lv2; msgClass = "fb-mid"; }
            else if (diem < 7) { selectedArr = msgList.lv3; msgClass = "fb-mid"; }
            else if (diem < 8) { selectedArr = msgList.lv4; msgClass = "fb-high"; }
            else if (diem <= 9) { selectedArr = msgList.lv5; msgClass = "fb-high"; } // Sá»­a 8-9 bao gá»“m cáº£ 9
            else { selectedArr = msgList.lv6; msgClass = "fb-high"; }

            // Random lá»i nháº¯n vÃ  thay tÃªn
            let randomMsg = selectedArr[Math.floor(Math.random() * selectedArr.length)];
            msg = randomMsg.replace("{ten}", ten);

            // ChÃ¨n vÃ o giao diá»‡n (ThÃªm tháº» div feedback náº¿u chÆ°a cÃ³)
            let resultContainer = document.getElementById('result-interface');
            let feedbackDiv = document.getElementById('feedback-msg');
            if (!feedbackDiv) {
                feedbackDiv = document.createElement('div');
                feedbackDiv.id = 'feedback-msg';
                // ChÃ¨n ngay dÆ°á»›i Ä‘iá»ƒm sá»‘ (score-display náº±m trong h2)
                resultContainer.insertBefore(feedbackDiv, document.getElementById('result-details'));
            }
            feedbackDiv.className = `feedback-msg ${msgClass}`;
            feedbackDiv.innerHTML = `<strong>Lá»i Tháº§y nháº¯n:</strong><br>"${msg}"`;

            // --- PHáº¦N Má»šI: HIá»‚N THá»Š MEME VUI ---
            // Kho meme (URL trá»±c tiáº¿p, load nhanh, tÃ´i chá»n meme vui, tÃ­ch cá»±c, phÃ¹ há»£p há»c sinh)
            const memeList = {
                low: [ // Chá»‰ 1 meme an á»§i cho dÆ°á»›i 6 Ä‘iá»ƒm (lv1 + lv2)
                    "https://i.etsystatic.com/57374706/r/il/a64e60/7342492873/il_fullxfull.7342492873_djeg.jpg"  // This is Fine dog - hÃ i hÆ°á»›c "khÃ´ng sao Ä‘Ã¢u, cá»‘ lÃªn"
                ],
                lv3: [ // 6-7 Ä‘iá»ƒm: khÃ¡ tá»‘t, cá»‘ thÃªm chÃºt
                    "https://cdn.eduadvisor.my/articles/2018/08/Hilarious-Exam-Meme-Charts-07-Things-i-think-during-the-exam.png",
                    "https://external-preview.redd.it/osZHapvJmkLLPmUkA9TP1OC_BEbFV97ESI-0NKr_XvI.jpg?auto=webp&s=964fa4a1ddd3024acd1df37e8547edce8c3d51e4",
                    "https://lookaside.fbsbx.com/lookaside/crawler/media/?media_id=1578894622142324",
                    "https://i.redd.it/llwtnsv0mmo91.jpg",
                    "https://new.boredteachers.com/wp-content/uploads/2022/01/Toxic-teachers-cover-2.jpg"
                ],
                lv4: [ // 7-8 Ä‘iá»ƒm: ráº¥t tá»‘t, success!
                    "https://www.mostlyblogging.com/wp-content/uploads/2025/06/ChatGPT-Image-Dec-4-2025-06_23_09-AM-700x467.png",  // Success Kid kiá»ƒu celebration
                    "https://www.thesun.co.uk/wp-content/uploads/2022/02/NINTCHDBPICT000706326625.jpg?strip=all&w=712",
                    "https://external-preview.redd.it/iHF2sPRodufnjzOnHCSD_xAGFa0phSTeIB8UFVY_jDA.jpg?auto=webp&s=f5e5ceb20df740b78745960077d8c2be4bb95570",
                    "https://lookaside.fbsbx.com/lookaside/crawler/media/?media_id=10171281177715274",
                    "https://www.tiktok.com/api/img/?itemId=7549048222145121591&location=0&aid=1988"
                ],
                lv5: [ // 8-9 Ä‘iá»ƒm: giá»i láº¯m, smart!
                    "https://file.aiquickdraw.com/tool-page/section-images/1755510614473utuxcrk5.webp",  // Spongebob rainbow kiá»ƒu "imagination/smart"
                    "https://bylo.ai/cdn-cgi/image/width=600,height=400,fit=scale-down,quality=85,format=webp/https://file.aiquickdraw.com/tool-page/section-images/1755509897072grkvlinq.webp",
                    "https://preview.redd.it/whats-the-best-spongebob-meme-ever-v0-bw1b0nmho38f1.jpeg?width=640&crop=smart&auto=webp&s=43c0fdfd8b3dbac8f054d9d4f9e34d14224a8472",
                    "https://davidwilliamrosales.com/wp-content/uploads/2022/06/screen-shot-2022-06-26-at-4.02.45-pm.png",
                    "https://cdn-useast1.kapwing.com/static/templates/spongebob-and-patrick-feeding-squidward-fruit-meme-template-regular-df7a6bf1.webp"
                ],
                lv6: [ // TrÃªn 9 Ä‘iá»ƒm: Ä‘á»‰nh chÃ³p, epic win!
                    "https://i.redd.it/jxf8utgw2r9e1.jpeg",
                    "https://static.boredpanda.com/blog/wp-content/uploads/2021/08/students-smart-response-to-teachers-fb73.png",
                    "https://www.tiktok.com/api/img/?itemId=7573770993202728206&location=0&aid=1988",
                    "https://preview.redd.it/the-not-so-glowing-reviews-v0-idsutxif06l91.jpg?width=640&crop=smart&auto=webp&s=47954de89dbb39ce329cae4c71633fce5509568f",
                    "https://www.boredpanda.com/blog/wp-content/uploads/2023/10/1710066466328871420-png__700.jpg"
                ]
            };

            // XÃ¡c Ä‘á»‹nh level meme
            let selectedMemeArr = [];
            if (diem < 6) {
                selectedMemeArr = memeList.low;
            } else if (diem < 7) {
                selectedMemeArr = memeList.lv3;
            } else if (diem < 8) {
                selectedMemeArr = memeList.lv4;
            } else if (diem <= 9) {
                selectedMemeArr = memeList.lv5;
            } else {
                selectedMemeArr = memeList.lv6;
            }

            // LuÃ´n hiá»ƒn thá»‹ nÃºt náº¿u cÃ³ meme (táº¥t cáº£ level Ä‘á»u cÃ³)
            let memeContainer = document.getElementById('meme-container');
            if (!memeContainer) {
                memeContainer = document.createElement('div');
                memeContainer.id = 'meme-container';
                memeContainer.style.display = 'none';  // áº¨n ban Ä‘áº§u
                memeContainer.style.marginTop = '20px';
                memeContainer.style.textAlign = 'center';
                feedbackDiv.insertAdjacentElement('afterend', memeContainer);
            }

            let memeButton = document.getElementById('meme-button');
            if (!memeButton) {
                memeButton = document.createElement('button');
                memeButton.id = 'meme-button';
                memeButton.textContent = 'Xem meme vui ğŸ˜‚';
                memeButton.style.marginTop = '15px';
                memeButton.style.padding = '10px 20px';
                memeButton.style.fontSize = '16px';
                memeButton.style.background = '#ffeb3b';
                memeButton.style.border = 'none';
                memeButton.style.borderRadius = '8px';
                memeButton.style.cursor = 'pointer';
                feedbackDiv.insertAdjacentElement('afterend', memeButton);

                memeButton.addEventListener('click', function() {
                    const randomMeme = selectedMemeArr[Math.floor(Math.random() * selectedMemeArr.length)];
                    memeContainer.innerHTML = `<img src="${randomMeme}" alt="Meme vui" loading="lazy" class="meme-img">`;
                    memeContainer.style.display = 'block';
                    memeButton.style.display = 'none';  // áº¨n nÃºt sau khi báº¥m
                });
            }
			
			// HIá»†U á»¨NG PHÃO HOA (Náº¿u Ä‘iá»ƒm >= 8)
            if (diem >= 8) {
                var duration = 3 * 1000;
                var animationEnd = Date.now() + duration;
                var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

                var interval = setInterval(function() {
                    var timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) { return clearInterval(interval); }
                    var particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            }
            // HÃ m phá»¥ trá»£ cho phÃ¡o hoa
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            
            // ----------------------------------------------

            // Render chi tiáº¿t (Giá»¯ nguyÃªn pháº§n cÅ©)
            let html = '';
            // ... (Pháº§n hiá»ƒn thá»‹ chi tiáº¿t cÃ¢u há»i giá»¯ nguyÃªn nhÆ° cÅ©)
            res.chiTiet.forEach((item, idx) => {
                let userChoice = baiLam[idx];
                let isCorrect = (item.diem > 0); 
                let color = isCorrect ? 'green' : 'red';
                let style = `border-bottom:1px solid #eee; padding:15px; background: ${isCorrect ? '#f0fff4' : '#fff5f5'}`;
                
                html += `<div style="${style}"><strong>CÃ¢u ${item.cau}:</strong> <span style="color:${color}; font-weight:bold">+${item.diem}</span>`;
                
                if (Array.isArray(item.ketQua)) { 
                     let visual = item.ketQua.map(k => k ? 'âœ…' : 'âŒ').join(' ');
                     let userText = userChoice.map(u => u===true?'Ä':(u===false?'S':'_')).join('-');
                     html += `<br>Káº¿t quáº£: ${visual} (Chá»n: ${userText})`;
                } else {
                    html += `<br>Káº¿t quáº£: ${item.ketQua === 'ÄÃºng' ? 'ÄÃºng' : 'Sai'} (Báº¡n chá»n: <b>${userChoice || 'Trá»‘ng'}</b>)`;
                }
                html += `</div>`;
            });
            document.getElementById('result-details').innerHTML = html;

        } catch(e) { 
            alert("Lá»—i ná»™p bÃ i! Vui lÃ²ng kiá»ƒm tra máº¡ng."); 
            console.error(e);
            // Má»Ÿ láº¡i nÃºt náº¿u lá»—i máº¡ng
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = originalText;
        }
    }

    // --- GIÃO VIÃŠN ---
    function showLoginAdmin() { hideAll(); document.getElementById('login-admin').style.display = 'block'; }

    async function loginAdmin() {
        const pass = document.getElementById('admin-pass').value;
        showLoader(true);
        const formData = new FormData();
        formData.append('action', 'admin_login');
        formData.append('pass', pass);
        const res = await fetch(API_URL, { method: 'POST', body: formData }).then(r => r.json());
        showLoader(false);
        if(res.status === 'ok') { hideAll(); document.getElementById('admin-panel').style.display = 'block'; } 
        else { alert(res.msg); }
    }

    async function luuDeThi() {
        const ma = document.getElementById('new-exam-code').value.trim();
        const ten = document.getElementById('new-exam-name').value.trim();
        const cfg = {
            p1_num: parseInt(document.getElementById('cfg-p1-num').value) || 0,
            p1_score: parseFloat(document.getElementById('cfg-p1-score').value) || 0,
            p2_num: parseInt(document.getElementById('cfg-p2-num').value) || 0,
            p2_mode: document.getElementById('cfg-p2-mode').value,
            p3_num: parseInt(document.getElementById('cfg-p3-num').value) || 0,
            p3_score: parseFloat(document.getElementById('cfg-p3-score').value) || 0
        };
        const raw = document.getElementById('exam-data-input').value;
        if(!ma || !ten || !raw) return alert("Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin!");

        let lines = raw.split('\n').filter(l => l.trim() !== "");
        let dapAn = [];
        let totalQ = cfg.p1_num + cfg.p2_num + cfg.p3_num;
        let currentLine = 0;
        
        function parseLine(line) { let dot = line.indexOf('.'); return dot === -1 ? line.trim() : line.substring(dot+1).trim(); }

        for(let i=0; i<cfg.p1_num; i++) {
            if(currentLine >= lines.length) break;
            dapAn.push({id: i+1, dang: 1, dapAn: parseLine(lines[currentLine++]).toUpperCase()});
        }
        for(let i=0; i<cfg.p2_num; i++) {
            if(currentLine >= lines.length) break;
            let arr = parseLine(lines[currentLine++]).split('').map(c => c.toUpperCase() === 'Ä');
            dapAn.push({id: dapAn.length+1, dang: 2, dapAn: arr, soY: 4});
        }
        for(let i=0; i<cfg.p3_num; i++) {
            if(currentLine >= lines.length) break;
            dapAn.push({id: dapAn.length+1, dang: 3, dapAn: parseFloat(parseLine(lines[currentLine++]).replace(',', '.'))});
        }

        if (dapAn.length !== totalQ) {
            if(!confirm(`Cáº¥u hÃ¬nh ${totalQ} cÃ¢u nhÆ°ng Ä‘á»c Ä‘Æ°á»£c ${dapAn.length} dÃ²ng. LÆ°u khÃ´ng?`)) return;
        }

        const payload = { maDe: ma, tenDe: ten, dapAn: dapAn, config: cfg };
        const formData = new FormData();
        formData.append('action', 'save_exam');
        formData.append('data', JSON.stringify(payload));
        
        showLoader(true);
        await fetch(API_URL, { method: 'POST', body: formData });
        alert("LÆ°u thÃ nh cÃ´ng!");
        showLoader(false);
    }
</script>

</body>
</html>

