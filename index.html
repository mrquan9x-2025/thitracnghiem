<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Teacher Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- LIBRARIES (ƒê√É C·∫¨P NH·∫¨T PHI√äN B·∫¢N CHU·∫®N) -->
    <!-- 1. Chart.js (UMD Version - ·ªîn ƒë·ªãnh nh·∫•t) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- 2. SheetJS (Xu·∫•t Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        #sidebar { width: 260px; height: 100vh; position: fixed; left: 0; top: 0; background: #343a40; color: #fff; overflow-y: auto; transition: 0.3s; z-index: 1000; }
        #sidebar .nav-link { color: #adb5bd; padding: 10px 20px; border-left: 4px solid transparent; cursor: pointer; }
        #sidebar .nav-link:hover, #sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: #0d6efd; }
        #sidebar .session-header { font-size: 0.75rem; text-transform: uppercase; color: #6c757d; padding: 15px 20px 5px; font-weight: bold; }
        #content { margin-left: 260px; height: 100vh; overflow-y: auto; padding: 20px; transition: 0.3s; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 100%; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-icon { font-size: 2rem; opacity: 0.2; position: absolute; right: 20px; top: 20px; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #343a40; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
        .table-cal { font-size: 0.9rem; }
        .table-cal th { background-color: #e9ecef; }
        @media (max-width: 768px) { #sidebar { left: -260px; } #sidebar.show { left: 0; } #content { margin-left: 0; } }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginOverlay">
        <div class="card p-4 shadow-lg text-center" style="width: 350px;">
            <h4 class="mb-3 text-primary"><i class="bi bi-shield-lock"></i> ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</h4>
            <input type="password" id="adminPass" class="form-control mb-3" placeholder="Nh·∫≠p m·∫≠t kh·∫©u Admin">
            <button onclick="loadData()" class="btn btn-primary w-100 fw-bold">Truy c·∫≠p Dashboard</button>
            <div id="loginMsg" class="text-danger mt-2 small"></div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="p-3 mb-2 bg-dark border-bottom border-secondary text-center">
            <h5 class="m-0 fw-bold text-white"><i class="bi bi-bar-chart-fill"></i> TEACHER ADMIN</h5>
            <small class="text-muted" id="subjectName">Loading...</small>
        </div>
        <div class="nav flex-column" id="sidebarMenu">
            <div class="nav-link active" onclick="renderOverview()"><i class="bi bi-grid-1x2-fill me-2"></i> T·ªîNG QUAN CHUNG</div>
            <!-- MENU T√çNH ƒêI·ªÇM -->
            <div class="nav-link text-warning" onclick="renderCalculationTool()">
                <i class="bi bi-calculator-fill me-2"></i> T√çNH ƒêI·ªÇM & XU·∫§T FILE
            </div>
            <div id="dynamicMenu"></div>
        </div>
        <div class="mt-auto p-3 text-center border-top border-secondary text-muted" style="font-size: 0.8rem;">Design by Ph·∫°m Th·∫ø Qu√¢n</div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="content">
        <button class="btn btn-outline-dark d-md-none mb-3" onclick="document.getElementById('sidebar').classList.toggle('show')">‚ò∞ Menu</button>
        <div id="mainView"></div>
    </div>

<script>
    // ===============================================================
    // D√ÅN LINK API C·ª¶A B·∫†N V√ÄO ƒê√ÇY
    const API_URL = "https://script.google.com/macros/s/AKfycbykuUiEuBtBWAV82C96_W4sNpD0scuyeGFdfskr29WiZA8e0ABPVwEcgN2Eo3cvRSA/exec"; 
    // ===============================================================

    var RAW_DATA = {};
    var PROCESSED_DATA = {}; 
    var ALL_STUDENTS = {}; 

    // --- 1. LOAD DATA ---
    function loadData() {
        var pass = document.getElementById('adminPass').value;
        document.getElementById('loginMsg').innerText = "ƒêang t·∫£i d·ªØ li·ªáu...";
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ type: 'get_admin_data', pass: pass }) })
        .then(res => res.json()).then(onDataLoaded)
        .catch(err => { document.getElementById('loginMsg').innerText = "L·ªói k·∫øt n·ªëi!"; console.error(err); });
    }

    function onDataLoaded(res) {
        if(res.error) { document.getElementById('loginMsg').innerText = res.error; return; }
        RAW_DATA = res;
        document.getElementById('subjectName').innerText = res.config.MON_HOC || "H·ªá th·ªëng ƒë√°nh gi√°";
        document.getElementById('loginOverlay').classList.add('hidden');
        res.students.forEach(s => { ALL_STUDENTS[s[0]] = { name: s[1], class: s[2], group: s[3] }; });
        processDataETL();
        renderSidebar();
        renderOverview();
    }

    // --- 2. ETL ---
    function processDataETL() {
        var sessions = {};
        function initGroup(s, g) {
            if(!sessions[s]) sessions[s] = {};
            if(!sessions[s][g]) sessions[s][g] = {
                peerTotal: 0, peerCount: 0, selfTotal: 0, selfCount: 0,
                reviewers: new Set(), selfReviewers: new Set(),
                comments: { peer: [], self: [], members: [] },
                membersPoints: {},
                // L∆∞u t·ªïng ƒëi·ªÉm t·ª´ng ti√™u ch√≠
                criteriaSums: { 
                    peer: new Array(RAW_DATA.criteria.length).fill(0), 
                    self: new Array(RAW_DATA.criteria.length).fill(0) 
                }
            };
        }
        
        function parseScore(jsonStr, type, groupObj) {
            try {
                var scores = JSON.parse(jsonStr); var total = 0;
                // C·ªông d·ªìn ƒëi·ªÉm th√¥ cho Chart
                RAW_DATA.criteria.forEach((c, idx) => {
                    var val = Number(scores['tc' + (idx+1)]) || 0;
                    groupObj.criteriaSums[type][idx] += val;
                });
                // T√≠nh ƒëi·ªÉm quy ƒë·ªïi
                var groupScores = {};
                RAW_DATA.criteria.forEach((c, idx) => {
                    var val = Number(scores['tc' + (idx+1)]) || 0;
                    if(!groupScores[c.group]) groupScores[c.group] = {act:0, max:0, w:c.weight};
                    groupScores[c.group].act += val; groupScores[c.group].max += c.max;
                });
                for(var g in groupScores) { var info = groupScores[g]; if(info.max > 0) total += (info.act / info.max) * 10 * info.w; }
                return total;
            } catch(e) { return 0; }
        }

        RAW_DATA.peerResults.forEach(r => { initGroup(r[1], r[3]); var d=sessions[r[1]][r[3]]; d.peerTotal+=parseScore(r[4],'peer',d); d.peerCount++; d.reviewers.add(String(r[2])); if(r[5]) d.comments.peer.push(r[5]); });
        RAW_DATA.selfResults.forEach(r => { initGroup(r[1], r[3]); var d=sessions[r[1]][r[3]]; d.selfTotal+=parseScore(r[4],'self',d); d.selfCount++; d.selfReviewers.add(String(r[2])); if(r[5]) d.comments.self.push(r[5]); if(r[6]) d.comments.members.push(r[6]); });
        RAW_DATA.contribResults.forEach(r => { initGroup(r[1], r[3]); var d=sessions[r[1]][r[3]]; if(!d.membersPoints[r[4]]) d.membersPoints[r[4]]=[]; d.membersPoints[r[4]].push(Number(r[5])); });
        PROCESSED_DATA = sessions;
    }

    // --- 3. RENDER SIDEBAR ---
    function renderSidebar() {
        var container = document.getElementById('dynamicMenu'); container.innerHTML = "";
        Object.keys(PROCESSED_DATA).sort().forEach(s => {
            var header = document.createElement('div'); header.className = 'session-header'; header.innerText = 'BU·ªîI ' + s; container.appendChild(header);
            Object.keys(PROCESSED_DATA[s]).sort((a,b)=>a-b).forEach(g => {
                var item = document.createElement('div'); item.className = 'nav-link'; item.innerHTML = `<i class="bi bi-people-fill me-2"></i> Nh√≥m ${g}`;
                item.onclick = function() { setActiveLink(this); renderGroupDetail(s, g); }; container.appendChild(item);
            });
        });
    }
    function setActiveLink(el) { document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); el.classList.add('active'); }

    // --- 4. T√çNH NƒÇNG T√çNH ƒêI·ªÇM ---
    function renderCalculationTool() {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.nav-link')[1].classList.add('active'); // Active n√∫t t√≠nh ƒëi·ªÉm

        var maxSession = Number(RAW_DATA.config.SO_BUOI) || 2;
        var sessionOpts = "";
        for(var i=1; i<=maxSession; i++) sessionOpts += `<option value="${i}">Bu·ªïi ${i}</option>`;

        var html = `<h3 class="mb-4 fw-bold text-dark"><i class="bi bi-calculator"></i> C√îNG C·ª§ T√çNH ƒêI·ªÇM</h3><ul class="nav nav-tabs mb-3" id="calcTabs"><li class="nav-item"><a class="nav-link active fw-bold" href="#" onclick="switchTab(1)">ƒêI·ªÇM TH√ÄNH PH·∫¶N</a></li><li class="nav-item"><a class="nav-link fw-bold" href="#" onclick="switchTab(2)">T·ªîNG K·∫æT CU·ªêI K·ª≤</a></li></ul><div id="tabSession"><div class="d-flex align-items-center mb-3"><span class="me-2 fw-bold">Ch·ªçn bu·ªïi:</span><select id="calcSessionSelect" class="form-select w-auto me-3" onchange="calcSessionScore()">${sessionOpts}</select><button class="btn btn-success" onclick="exportExcel('tblSessionScore', 'Diem_Thanh_Phan')"><i class="bi bi-file-earmark-excel"></i> Xu·∫•t Excel</button></div><div class="table-responsive bg-white shadow-sm p-3 rounded"><table class="table table-bordered table-cal table-hover" id="tblSessionScore"><thead><tr><th>Bu·ªïi</th><th>Nh√≥m</th><th>M√£ SV</th><th>H·ªç T√™n</th><th>ƒêi·ªÉm Peer</th><th>ƒêi·ªÉm Self</th><th>ƒêi·ªÉm Nh√≥m</th><th>ƒê√≥ng G√≥p</th><th>ƒêI·ªÇM C√Å NH√ÇN</th></tr></thead><tbody id="tbodySession"></tbody></table></div></div><div id="tabFinal" class="hidden"><div class="mb-3"><button class="btn btn-primary" onclick="calcFinalScore()"><i class="bi bi-arrow-repeat"></i> T√≠nh to√°n l·∫°i</button><button class="btn btn-success ms-2" onclick="exportExcel('tblFinalScore', 'Bang_Diem_Tong_Ket')"><i class="bi bi-file-earmark-excel"></i> Xu·∫•t Excel</button></div><div class="table-responsive bg-white shadow-sm p-3 rounded"><table class="table table-bordered table-cal table-hover" id="tblFinalScore"><thead><tr id="trFinalHeader"></tr></thead><tbody id="tbodyFinal"></tbody></table></div></div>`;
        document.getElementById('mainView').innerHTML = html;
        calcSessionScore();
    }

    function switchTab(tabId) {
        if(tabId==1) { document.getElementById('tabSession').classList.remove('hidden'); document.getElementById('tabFinal').classList.add('hidden'); document.querySelectorAll('#calcTabs .nav-link')[0].classList.add('active'); document.querySelectorAll('#calcTabs .nav-link')[1].classList.remove('active'); } 
        else { document.getElementById('tabSession').classList.add('hidden'); document.getElementById('tabFinal').classList.remove('hidden'); document.querySelectorAll('#calcTabs .nav-link')[0].classList.remove('active'); document.querySelectorAll('#calcTabs .nav-link')[1].classList.add('active'); calcFinalScore(); }
    }

    function calcSessionScore() {
        var sess = document.getElementById('calcSessionSelect').value;
        var tbody = document.getElementById('tbodySession'); tbody.innerHTML = "";
        if(!PROCESSED_DATA[sess]) { tbody.innerHTML = "<tr><td colspan='9' class='text-center'>Ch∆∞a c√≥ d·ªØ li·ªáu bu·ªïi n√†y</td></tr>"; return; }
        var wPeer = (RAW_DATA.config.TRONG_SO_PEER || 100)/100; var wSelf = (RAW_DATA.config.TRONG_SO_SELF || 0)/100; var formula = RAW_DATA.config.CONG_THUC_CN || "NHAN_HE_SO";
        var rows = [];
        Object.keys(PROCESSED_DATA[sess]).sort((a,b)=>a-b).forEach(g => {
            var d = PROCESSED_DATA[sess][g]; var pScore = d.peerCount > 0 ? d.peerTotal/d.peerCount : 0; var sScore = d.selfCount > 0 ? d.selfTotal/d.selfCount : 0;
            var wp = wPeer, ws = wSelf; if(ws > 0 && sScore == 0) { wp = 1; ws = 0; }
            var grpScore = (pScore * wp) + (sScore * ws);
            for(var mID in d.membersPoints) {
                var pts = d.membersPoints[mID]; var avgContrib = pts.reduce((a,b)=>a+b,0)/pts.length; var final = 0;
                if(formula == "CONG_TRU") final = grpScore + (avgContrib - 10); else final = grpScore * (avgContrib/10);
                rows.push({ sess: sess, grp: g, msv: mID, name: ALL_STUDENTS[mID] ? ALL_STUDENTS[mID].name : mID, p: pScore, s: sScore, gSc: grpScore, c: avgContrib, f: final });
            }
        });
        rows.forEach(r => { tbody.innerHTML += `<tr><td>${r.sess}</td><td>${r.grp}</td><td>${r.msv}</td><td>${r.name}</td><td>${r.p.toFixed(2)}</td><td>${r.s.toFixed(2)}</td><td class="fw-bold text-primary">${r.gSc.toFixed(2)}</td><td>${r.c.toFixed(2)}</td><td class="fw-bold text-danger">${r.f.toFixed(2)}</td></tr>`; });
    }

    function calcFinalScore() {
        var maxSession = Number(RAW_DATA.config.SO_BUOI) || 2;
        var headerRow = `<th>M√£ SV</th><th>H·ªç T√™n</th><th>Nh√≥m</th>`; for(var i=1; i<=maxSession; i++) headerRow += `<th>Bu·ªïi ${i}</th>`; headerRow += `<th class="bg-warning">T·ªîNG K·∫æT</th>`; document.getElementById('trFinalHeader').innerHTML = headerRow;
        var tbody = document.getElementById('tbodyFinal'); tbody.innerHTML = "";
        var studentScores = {}; var wPeer = (RAW_DATA.config.TRONG_SO_PEER || 100)/100; var wSelf = (RAW_DATA.config.TRONG_SO_SELF || 0)/100; var formula = RAW_DATA.config.CONG_THUC_CN || "NHAN_HE_SO";
        for(var s in PROCESSED_DATA) { for(var g in PROCESSED_DATA[s]) { var d = PROCESSED_DATA[s][g]; var pScore = d.peerCount > 0 ? d.peerTotal/d.peerCount : 0; var sScore = d.selfCount > 0 ? d.selfTotal/d.selfCount : 0; var wp = wPeer, ws = wSelf; if(ws > 0 && sScore == 0) { wp = 1; ws = 0; } var grpScore = (pScore * wp) + (sScore * ws); for(var mID in d.membersPoints) { var pts = d.membersPoints[mID]; var avgContrib = pts.reduce((a,b)=>a+b,0)/pts.length; var final = (formula == "CONG_TRU") ? (grpScore + avgContrib - 10) : (grpScore * avgContrib/10); if(!studentScores[mID]) studentScores[mID] = {}; studentScores[mID][s] = final; } } }
        var svList = Object.keys(ALL_STUDENTS).filter(id => ALL_STUDENTS[id].class); svList.sort();
        svList.forEach(id => { var sInfo = ALL_STUDENTS[id]; var scoresHtml = ""; var sum = 0; for(var i=1; i<=maxSession; i++) { var sc = studentScores[id] ? studentScores[id][i] : undefined; if(sc !== undefined) { scoresHtml += `<td>${sc.toFixed(2)}</td>`; sum += sc; } else { scoresHtml += `<td class="text-muted">-</td>`; } } var final = sum / maxSession; tbody.innerHTML += `<tr><td>${id}</td><td>${sInfo.name}</td><td>${sInfo.group}</td>${scoresHtml}<td class="fw-bold bg-light">${final.toFixed(2)}</td></tr>`; });
    }

    function exportExcel(tableId, filename) { var wb = XLSX.utils.table_to_book(document.getElementById(tableId), {sheet:"Sheet 1"}); XLSX.writeFile(wb, filename + ".xlsx"); }

    // --- 5. RENDER OVERVIEW (C≈®) ---
    function renderOverview() {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.nav-link')[0].classList.add('active');
        var analysis = analyzeData();
        var topGroupsHtml = analysis.topGroups.map((g, i) => `<tr><td>${i+1}</td><td>Bu·ªïi ${g.s} - Nh√≥m ${g.g}</td><td class="fw-bold text-primary">${g.final.toFixed(2)}</td></tr>`).join('');
        var topMembersHtml = analysis.topMembers.map((m, i) => { var svName = ALL_STUDENTS[m.id] ? ALL_STUDENTS[m.id].name : m.id; return `<tr><td>${i+1}</td><td>${svName}</td><td>B${m.s}-N${m.g}</td><td class="fw-bold text-success">${m.pt.toFixed(2)}</td></tr>`; }).join('');
        var html = `<h3 class="mb-4 fw-bold text-dark"><i class="bi bi-speedometer2"></i> T·ªîNG QUAN ƒê√ÅNH GI√Å</h3><div class="row mb-4"><div class="col-md-6 mb-3"><div class="card h-100 border-0 shadow-sm"><div class="card-header bg-primary text-white fw-bold"><i class="bi bi-trophy"></i> TOP 3 NH√ìM XU·∫§T S·∫ÆC</div><div class="card-body p-0"><table class="table table-striped mb-0"><thead><tr><th>#</th><th>Nh√≥m</th><th>ƒêi·ªÉm Final</th></tr></thead><tbody>${topGroupsHtml}</tbody></table></div></div></div><div class="col-md-6 mb-3"><div class="card h-100 border-0 shadow-sm"><div class="card-header bg-success text-white fw-bold"><i class="bi bi-person-check"></i> TOP 3 C√Å NH√ÇN ƒê√ìNG G√ìP CAO (KH√ÅC NH√ìM)</div><div class="card-body p-0"><table class="table table-striped mb-0"><thead><tr><th>#</th><th>Sinh vi√™n</th><th>Nh√≥m</th><th>ƒêi·ªÉm ƒêG</th></tr></thead><tbody>${topMembersHtml}</tbody></table></div></div></div></div><div class="row">${renderWidget('T·ª± tin th√°i qu√°', 'text-danger', 'bi-arrow-up-right-circle', analysis.overConf)}${renderWidget('L√†m t·ªët h∆°n nghƒ©', 'text-success', 'bi-arrow-down-left-circle', analysis.underConf)}${renderWidget('T·ª± nh·∫≠n th·ª©c t·ªët', 'text-info', 'bi-check-circle', analysis.bestAware)}</div>`;
        document.getElementById('mainView').innerHTML = html;
    }
    function renderWidget(title, colorCls, icon, data) { if(!data) return ''; var diffLabel = data.diff > 0 ? `+${data.diff.toFixed(2)}` : data.diff.toFixed(2); return `<div class="col-md-4 mb-3"><div class="stat-card position-relative border-start border-4 border-${colorCls.split('-')[1]}"><h6 class="text-muted text-uppercase fw-bold">${title}</h6><h3 class="fw-bold my-2">Bu·ªïi ${data.s} - Nh√≥m ${data.g}</h3><div class="${colorCls} fw-bold mt-2">Ch√™nh l·ªách: <span class="badge bg-light ${colorCls} border">${diffLabel}</span></div><div class="small text-muted mt-1">Self: ${data.self.toFixed(2)} | Peer: ${data.peer.toFixed(2)}</div><i class="bi ${icon} stat-icon text-dark"></i></div></div>`; }
    function analyzeData() {
        var groups = []; var allMembers = []; var wPeer = (RAW_DATA.config.TRONG_SO_PEER || 100)/100; var wSelf = (RAW_DATA.config.TRONG_SO_SELF || 0)/100;
        for(var s in PROCESSED_DATA) { for(var g in PROCESSED_DATA[s]) { var d = PROCESSED_DATA[s][g]; var pScore = d.peerCount > 0 ? d.peerTotal/d.peerCount : 0; var sScore = d.selfCount > 0 ? d.selfTotal/d.selfCount : 0; var final = (pScore * wPeer) + (sScore * wSelf); if(pScore > 0 && sScore > 0) { var diff = sScore - pScore; groups.push({ s:s, g:g, peer:pScore, self:sScore, final:final, diff:diff, absDiff: Math.abs(diff) }); } for(var mID in d.membersPoints) { var pts = d.membersPoints[mID]; var avg = pts.reduce((a,b)=>a+b,0)/pts.length; allMembers.push({ s:s, g:g, id:mID, pt:avg }); } } }
        allMembers.sort((a,b) => b.pt - a.pt); var top3Members = []; var usedGroups = new Set(); for(var m of allMembers) { var groupKey = m.s + "-" + m.g; if(!usedGroups.has(groupKey)) { top3Members.push(m); usedGroups.add(groupKey); } if(top3Members.length >= 3) break; } groups.sort((a,b) => b.final - a.final);
        return { topGroups: groups.slice(0, 3), topMembers: top3Members, overConf: [...groups].sort((a,b) => b.diff - a.diff)[0], underConf: [...groups].sort((a,b) => a.diff - b.diff)[0], bestAware: [...groups].sort((a,b) => a.absDiff - b.absDiff)[0] };
    }

    // --- 6. RENDER DETAIL (ƒê√É S·ª¨A CHART DELAY) ---
    function renderGroupDetail(s, g) {
        var d = PROCESSED_DATA[s][g]; var pScore = d.peerCount > 0 ? (d.peerTotal/d.peerCount).toFixed(2) : "0.00"; var sScore = d.selfCount > 0 ? (d.selfTotal/d.selfCount).toFixed(2) : "0.00";
        var missingPeerHtml = "", missingSelfHtml = ""; var countMP = 0, countMS = 0;
        for(var svID in ALL_STUDENTS) { var std = ALL_STUDENTS[svID]; if(std.class) { if(String(std.group) != String(g) && !d.reviewers.has(String(svID))) { missingPeerHtml += `<div class="badge bg-light text-danger border border-danger me-1 mb-1 fw-normal">${std.name}</div>`; countMP++; } if(String(std.group) == String(g) && !d.selfReviewers.has(String(svID))) { missingSelfHtml += `<div class="badge bg-light text-danger border border-danger me-1 mb-1 fw-normal">${std.name}</div>`; countMS++; } } }
        if(missingPeerHtml == "") missingPeerHtml = "<span class='text-success small'>ƒê·∫ßy ƒë·ªß</span>"; if(missingSelfHtml == "") missingSelfHtml = "<span class='text-success small'>ƒê·∫ßy ƒë·ªß</span>";
        var memHtml = ""; var memList = []; for(var mID in d.membersPoints) { var avg = d.membersPoints[mID].reduce((a,b)=>a+b,0) / d.membersPoints[mID].length; memList.push({ id:mID, avg:avg }); } memList.sort((a,b) => b.avg - a.avg); memList.forEach((m, idx) => { var name = ALL_STUDENTS[m.id] ? ALL_STUDENTS[m.id].name : m.id; memHtml += `<tr><td>${idx+1}</td><td>${name}</td><td class="fw-bold text-center">${m.avg.toFixed(2)}</td></tr>`; });
        var pCommHtml = d.comments.peer.map(c => `<div class="border-bottom py-1 small">üîπ ${c}</div>`).join('') || '<i class="text-muted">Kh√¥ng c√≥</i>'; var sCommHtml = d.comments.self.map(c => `<div class="border-bottom py-1 small text-success">üî∏ ${c}</div>`).join('') || '<i class="text-muted">Kh√¥ng c√≥</i>'; var mCommHtml = d.comments.members.map(c => `<div class="border-bottom py-1 small text-secondary">‚ñ™Ô∏è ${c}</div>`).join('') || '<i class="text-muted">Kh√¥ng c√≥</i>';
        var html = `<div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2"><h3 class="fw-bold m-0 text-dark">BU·ªîI ${s} - NH√ìM ${g}</h3><div><span class="badge bg-primary fs-6 me-2 shadow-sm">Peer: ${pScore} (${d.peerCount} phi·∫øu)</span><span class="badge bg-success fs-6 shadow-sm">Self: ${sScore} (${d.selfCount} phi·∫øu)</span></div></div><div class="row"><div class="col-lg-6 mb-4"><div class="card shadow-sm h-100"><div class="card-header fw-bold bg-white"><i class="bi bi-pie-chart"></i> BI·ªÇU ƒê·ªí RADAR (ƒêI·ªÇM TRUNG B√åNH)</div><div class="card-body"><canvas id="detailChart"></canvas></div></div></div><div class="col-lg-6 mb-4"><div class="card shadow-sm h-100"><div class="card-header fw-bold bg-white"><i class="bi bi-people"></i> ƒêI·ªÇM ƒê√ìNG G√ìP TH√ÄNH VI√äN</div><div class="card-body p-0"><table class="table table-hover mb-0 align-middle"><thead class="table-light"><tr><th>#</th><th>H·ªç t√™n</th><th class="text-center">ƒêi·ªÉm TB</th></tr></thead><tbody>${memHtml}</tbody></table></div></div></div></div><div class="row mb-4"><div class="col-12"><div class="card shadow-sm"><div class="card-header fw-bold bg-white"><i class="bi bi-chat-left-text"></i> NH·∫¨N X√âT CHI TI·∫æT</div><div class="card-body"><div class="row"><div class="col-md-4 border-end"><h6 class="text-primary border-bottom pb-2 small fw-bold">PEER REVIEW</h6><div style="max-height: 250px; overflow-y: auto;">${pCommHtml}</div></div><div class="col-md-4 border-end"><h6 class="text-success border-bottom pb-2 small fw-bold">SELF REVIEW</h6><div style="max-height: 250px; overflow-y: auto;">${sCommHtml}</div></div><div class="col-md-4"><h6 class="text-secondary border-bottom pb-2 small fw-bold">TH√ÄNH VI√äN (N·ªòI B·ªò)</h6><div style="max-height: 250px; overflow-y: auto;">${mCommHtml}</div></div></div></div></div></div></div><div class="row"><div class="col-12"><div class="card shadow-sm border-danger"><div class="card-header bg-danger text-white fw-bold d-flex justify-content-between"><span><i class="bi bi-exclamation-triangle-fill"></i> DANH S√ÅCH CH∆ØA ƒê√ÅNH GI√Å</span><span class="badge bg-white text-danger">${countMP + countMS} SV</span></div><div class="card-body"><div class="row"><div class="col-md-6 border-end"><h6 class="text-danger small fw-bold">CH∆ØA PEER REVIEW (${countMP})</h6><div style="max-height: 150px; overflow-y: auto;">${missingPeerHtml}</div></div><div class="col-md-6"><h6 class="text-danger small fw-bold">CH∆ØA SELF REVIEW (${countMS})</h6><div style="max-height: 150px; overflow-y: auto;">${missingSelfHtml}</div></div></div></div></div></div></div>`;
        document.getElementById('mainView').innerHTML = html;
        
        // V·∫º BI·ªÇU ƒê·ªí (C√ì DELAY ƒê·ªÇ ƒê·∫¢M B·∫¢O DOM RENDER XONG)
        setTimeout(() => { drawChart(d); }, 100);
    }

    var detailChart = null;
    function drawChart(dataObj) {
        var canvas = document.getElementById('detailChart');
        if(!canvas) { console.error("Canvas not found!"); return; }
        var ctx = canvas.getContext('2d');
        
        var labels = RAW_DATA.criteria.map(c => c.title.substring(0, 15) + '...');
        var pVals = dataObj.criteriaSums.peer.map(v => dataObj.peerCount > 0 ? (v/dataObj.peerCount) : 0);
        var sVals = dataObj.criteriaSums.self.map(v => dataObj.selfCount > 0 ? (v/dataObj.selfCount) : 0);

        if(detailChart) detailChart.destroy();

        detailChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Peer Review',
                    data: pVals,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }, {
                    label: 'Self Review',
                    data: sVals,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                scales: { r: { suggestedMin: 0, suggestedMax: 10 } },
                plugins: { tooltip: { enabled: true } }, // B·∫¨T TOOLTIP
                maintainAspectRatio: false
            }
        });
    }
</script>
</body>
</html>
